{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Crop Recommendation" %} - Krishibazaar{% endblock %}

{% block extra_css %}
<style>
.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.progress-bar {
    transition: width 0.6s ease;
}
.crop-card {
    transition: transform 0.3s ease;
}
.crop-card:hover {
    transform: translateY(-5px);
}
.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 1rem;
}
.data-table {
    width: 100%;
    margin-bottom: 1rem;
}
.data-table th, .data-table td {
    padding: 0.75rem;
    vertical-align: middle;
}
.data-table input, .data-table select {
    width: 100%;
}
.real-time-results {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">{% trans "Crop Recommendation System" %}</h1>

    {% if messages %}
    <div class="mb-8">
        {% for message in messages %}
        <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Form Section -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <form id="recommendationForm" method="POST" class="space-y-6">
                {% csrf_token %}
                
                {% for field in form %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ field.label }}
                    </label>
                    {{ field }}
                    {% if field.errors %}
                    <div class="text-red-500 text-sm mt-1">
                        {{ field.errors|join:", " }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}

                <div class="mt-6">
                    <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        {% trans "Get Recommendations" %}
                    </button>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="{% if not recommended_crops %}hidden{% endif %}">
            <div id="loadingIndicator" class="hidden">
                <div class="flex items-center justify-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
                </div>
            </div>

            <div id="recommendationResults" class="space-y-8">
                {% if recommended_crops %}
                <!-- Suitability Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">{% trans "Crop Suitability Analysis" %}</h2>
                    <div id="suitabilityChart"></div>
                </div>

                <!-- Profit Analysis Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">{% trans "Financial Analysis" %}</h2>
                    <div id="profitChart"></div>
                </div>

                <!-- Market Analysis Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">{% trans "Market Analysis" %}</h2>
                    <div id="marketChart"></div>
                </div>

                <!-- Recommended Crops -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">{% trans "Recommended Crops" %}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="cropCards">
                        {% for crop in recommended_crops %}
                        <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                            {% if crop.image_url %}
                            <img src="{{ crop.image_url }}" alt="{{ crop.name }}" class="w-full h-48 object-cover rounded-lg mb-4">
                            {% endif %}
                            <h3 class="text-lg font-semibold">{{ crop.name }}</h3>
                            <p class="text-gray-600 text-sm mb-2">{{ crop.description }}</p>
                            <div class="space-y-1">
                                <p><span class="font-medium">Suitability:</span> {{ crop.suitability_score }}%</p>
                                <p><span class="font-medium">Est. Yield:</span> {{ crop.estimated_yield }} tons</p>
                                <p><span class="font-medium">Est. Revenue:</span> ₹{{ crop.estimated_revenue|floatformat:2 }}</p>
                                <p><span class="font-medium">Est. Profit:</span> ₹{{ crop.estimated_profit|floatformat:2 }}</p>
                                <p><span class="font-medium">Profit Margin:</span> {{ crop.profit_margin }}%</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('cropRecommendationForm');
        const resultsContainer = document.getElementById('resultsContainer');
        const recommendationsList = document.getElementById('recommendationsList');
        const quickFillButton = document.getElementById('quickFillButton');
        const newAnalysisButton = document.getElementById('newAnalysisButton');
        const soilAnalysis = document.getElementById('soilAnalysis');
        
        let cropChart, nutrientChart;
    
        // Quick fill form with example data
        quickFillButton.addEventListener('click', function() {
            document.getElementById('nitrogen').value = 90;
            document.getElementById('phosphorus').value = 42;
            document.getElementById('potassium').value = 43;
            document.getElementById('temperature').value = 20.87;
            document.getElementById('humidity').value = 82;
            document.getElementById('ph').value = 6.5;
            document.getElementById('rainfall').value = 202.9;
        });
    
        // New analysis button - scroll back to form on mobile
        if (newAnalysisButton) {
            newAnalysisButton.addEventListener('click', function() {
                // On mobile, scroll back to form
                if (window.innerWidth < 992) {
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        }
    
        // Critical fix: Prevent default form submission
        form.addEventListener('submit', function(event) {
            // This is essential - stops the form from submitting normally
            event.preventDefault();
            
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            // Get form data
            const formData = {
                nitrogen: parseFloat(document.getElementById('nitrogen').value),
                phosphorus: parseFloat(document.getElementById('phosphorus').value),
                potassium: parseFloat(document.getElementById('potassium').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                humidity: parseFloat(document.getElementById('humidity').value),
                ph: parseFloat(document.getElementById('ph').value),
                rainfall: parseFloat(document.getElementById('rainfall').value),
                region: document.getElementById('region').value || null
            };
            
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Show loading state
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            
            // Use proper fetch API with error handling
            fetch('/api/crop-recommendation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(formData),
                // Important: Add these options to prevent redirect
                redirect: 'follow',
                mode: 'cors',
                cache: 'no-cache'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data);
                // Process recommendations
                // Handle empty recommendations array
                if (!data.recommendations || data.recommendations.length === 0) {
                    // Use mock data if recommendations are empty
                    console.log("No recommendations received, using mock data");
                    data = getMockRecommendations(formData);
                }
                displayRecommendations(data, formData);
            })
            .catch(error => {
                console.error('Error:', error);
                
                // For demo purposes, show mock data if API fails
                const mockData = getMockRecommendations(formData);
                displayRecommendations(mockData, formData);
            })
            .finally(() => {
                // Reset button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Get Recommendations';
            });
        });
    
        function displayRecommendations(data, formData) {
            // Clear previous recommendations
            recommendationsList.innerHTML = '';
            
            // Show results container
            resultsContainer.style.display = 'block';
            
            // Handle the case where recommendations might be empty
            if (!data.recommendations || data.recommendations.length === 0) {
                recommendationsList.innerHTML = '<li class="list-group-item text-center">No specific crop recommendations available for these conditions.</li>';
            } else {
                // Add each recommendation to the list
                data.recommendations.forEach(crop => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.innerHTML = `
                        ${crop.name}
                        <span class="badge bg-primary rounded-pill">${crop.probability}%</span>
                    `;
                    recommendationsList.appendChild(listItem);
                });
            }
            
            // Display soil analysis
            soilAnalysis.innerHTML = generateSoilAnalysis(formData);
            
            // Create charts only if recommendations exist
            if (data.recommendations && data.recommendations.length > 0) {
                createCharts(data);
            } else {
                // Create simple chart for soil data only
                createSoilOnlyChart(formData);
            }
            
            // On mobile, scroll to results
            if (window.innerWidth < 992) {
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    
        function createSoilOnlyChart(formData) {
            // Destroy previous charts if they exist
            if (cropChart) cropChart.destroy();
            if (nutrientChart) nutrientChart.destroy();
            
            // Create nutrient balance chart
            const nutrientCtx = document.getElementById('nutrientChart').getContext('2d');
            nutrientChart = new Chart(nutrientCtx, {
                type: 'bar',
                data: {
                    labels: ['Nitrogen (N)', 'Phosphorus (P)', 'Potassium (K)'],
                    datasets: [{
                        label: 'Your Soil',
                        data: [
                            formData.nitrogen,
                            formData.phosphorus,
                            formData.potassium
                        ],
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Level (mg/kg)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Soil Nutrient Analysis'
                        }
                    }
                }
            });
            
            // Create a placeholder for the pie chart area
            const cropCtx = document.getElementById('cropChart').getContext('2d');
            cropChart = new Chart(cropCtx, {
                type: 'bar',
                data: {
                    labels: ['pH', 'Temperature', 'Humidity', 'Rainfall'],
                    datasets: [{
                        label: 'Your Conditions',
                        data: [
                            formData.ph,
                            formData.temperature,
                            formData.humidity,
                            formData.rainfall / 10 // Scale down for visualization
                        ],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(241, 196, 15, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(155, 89, 182, 1)',
                            'rgba(241, 196, 15, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Environmental Conditions'
                        }
                    }
                }
            });
        }
    
        function generateSoilAnalysis(formData) {
            let analysis = '';
            
            // NPK analysis
            if (formData.nitrogen < 50) {
                analysis += '<strong>Nitrogen:</strong> Low - Consider nitrogen-rich fertilizers.<br>';
            } else if (formData.nitrogen > 100) {
                analysis += '<strong>Nitrogen:</strong> High - Suitable for leafy vegetables.<br>';
            } else {
                analysis += '<strong>Nitrogen:</strong> Medium - Good balance for most crops.<br>';
            }
            
            // pH analysis
            if (formData.ph < 5.5) {
                analysis += '<strong>pH:</strong> Acidic - May require liming to raise pH.<br>';
            } else if (formData.ph > 7.5) {
                analysis += '<strong>pH:</strong> Alkaline - Consider soil amendments to lower pH.<br>';
            } else {
                analysis += '<strong>pH:</strong> Neutral - Ideal for most crops.<br>';
            }
            
            // Moisture analysis
            if (formData.rainfall < 80) {
                analysis += '<strong>Moisture:</strong> Low rainfall - Irrigation recommended.<br>';
            } else if (formData.rainfall > 200) {
                analysis += '<strong>Moisture:</strong> High rainfall - Ensure good drainage.<br>';
            } else {
                analysis += '<strong>Moisture:</strong> Moderate rainfall - Good growing conditions.<br>';
            }
            
            return analysis;
        }
    
        function createCharts(data) {
            // Destroy previous charts if they exist
            if (cropChart) cropChart.destroy();
            if (nutrientChart) nutrientChart.destroy();
            
            // Create crop recommendation chart
            const cropCtx = document.getElementById('cropChart').getContext('2d');
            cropChart = new Chart(cropCtx, {
                type: 'pie',
                data: {
                    labels: data.recommendations.map(crop => crop.name),
                    datasets: [{
                        data: data.recommendations.map(crop => crop.probability),
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(230, 126, 34, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(155, 89, 182, 1)',
                            'rgba(241, 196, 15, 1)',
                            'rgba(230, 126, 34, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Crop Recommendation Probabilities'
                        }
                    }
                }
            });
            
            // Create nutrient balance chart
            const nutrientCtx = document.getElementById('nutrientChart').getContext('2d');
            nutrientChart = new Chart(nutrientCtx, {
                type: 'bar',
                data: {
                    labels: ['Nitrogen (N)', 'Phosphorus (P)', 'Potassium (K)'],
                    datasets: [{
                        label: 'Your Soil',
                        data: [
                            data.soil_data ? data.soil_data.nitrogen : formData.nitrogen,
                            data.soil_data ? data.soil_data.phosphorus : formData.phosphorus,
                            data.soil_data ? data.soil_data.potassium : formData.potassium
                        ],
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Level (mg/kg)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Soil Nutrient Analysis'
                        }
                    }
                }
            });
        }
    
        // Function to generate mock recommendations for demonstration
        function getMockRecommendations(formData) {
            // This would be replaced by actual API response in production
            const mockCrops = [
                {name: 'Rice', probability: 85},
                {name: 'Wheat', probability: 70},
                {name: 'Maize', probability: 65},
                {name: 'Cotton', probability: 45},
                {name: 'Sugarcane', probability: 40}
            ];
            
            // Sort based on "suitability" calculated from input data
            // This is simplified logic for demo purposes
            mockCrops.sort((a, b) => {
                // Simple weighted scoring
                const getScore = (crop) => {
                    if (crop.name === 'Rice') {
                        return (formData.rainfall > 100) ? 95 : 85;
                    } else if (crop.name === 'Wheat') {
                        return (formData.temperature < 25) ? 90 : 70;
                    } else if (crop.name === 'Maize') {
                        return (formData.nitrogen > 80) ? 85 : 65;
                    } else if (crop.name === 'Cotton') {
                        return (formData.ph > 6) ? 75 : 45;
                    } else {
                        return (formData.potassium > 40) ? 70 : 40;
                    }
                };
                
                return getScore(b) - getScore(a);
            });
            
            return {
                recommendations: mockCrops,
                soil_data: {
                    nitrogen: formData.nitrogen,
                    phosphorus: formData.phosphorus,
                    potassium: formData.potassium
                }
            };
        }
    });
</script>
{% endblock %}